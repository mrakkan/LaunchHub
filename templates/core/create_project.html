{% extends 'core/base.html' %}

{% block title %}Create Project - LaunchHub{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0"><i class="bi bi-plus-circle"></i> Create New Project</h4>
            </div>
            <div class="card-body">
                {% if form and form.errors %}
                <div class="alert alert-danger" role="alert">
                    <strong>ไม่สามารถสร้างโปรเจกต์ได้:</strong>
                    <ul class="mb-0">
                        {% for field, errors in form.errors.items %}
                            {% for error in errors %}
                                <li>{{ field|title }}: {{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                        {% for error in form.non_field_errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="name" class="form-label">Project Name *</label>
                        <input type="text" class="form-control" id="name" name="name" value="{{ form.name.value|default:'' }}" required>
                        <div class="form-text">Choose a unique name for your project</div>
                        {% if form.name.errors %}
                        <div class="text-danger small">{{ form.name.errors|join:', ' }}</div>
                        {% endif %}
                    </div>
                    
                    {% if has_github_connected and github_repos %}
                    <div class="mb-3">
                        <label for="repo_select" class="form-label">Select GitHub Repository *</label>
                        <select class="form-select" id="repo_select" style="background-color: #121315; color: white;" required>
                            <option value="" selected disabled>-- Select a repository --</option>
                            {% for r in github_repos %}
                                <option value="{{ r.clone_url }}" data-name="{{ r.name }}">{{ r.full_name }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">Repositories fetched from your GitHub</div>
                    </div>
                    {% endif %}

                    <div class="mb-3">
                        <label for="github_repo_url" class="form-label">GitHub Repository URL *</label>
                        <input type="url" class="form-control" id="github_repo_url" name="github_repo_url" 
                               placeholder="https://github.com/username/repository" value="{{ form.github_repo_url.value|default:'' }}" required>
                        <div class="form-text">The GitHub repository containing your application code</div>
                        {% if form.github_repo_url.errors %}
                        <div class="text-danger small">{{ form.github_repo_url.errors|join:', ' }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="is_public" name="is_public" {% if form.is_public.value %}checked{% endif %}>
                            <label class="form-check-label" for="is_public">
                                Make this project public (others can view and deploy)
                            </label>
                        </div>
                    </div>

                    <!-- Advanced build & run settings -->
                    <div class="mb-3">
                        <label for="dockerfile_path" class="form-label">Dockerfile Path</label>
                        <input type="text" class="form-control" id="dockerfile_path" name="dockerfile_path" placeholder="Dockerfile" value="{{ form.dockerfile_path.value|default:'' }}">
                        <div class="form-text">Relative path to Dockerfile (default: Dockerfile at repository root)</div>
                        {% if form.dockerfile_path.errors %}
                        <div class="text-danger small">{{ form.dockerfile_path.errors|join:', ' }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="build_command" class="form-label">Custom Build Command</label>
                        <input type="text" class="form-control" id="build_command" name="build_command" placeholder="Optional" value="{{ form.build_command.value|default:'' }}">
                        <div class="form-text">Optional. Example: npm install && npm run build</div>
                        {% if form.build_command.errors %}
                        <div class="text-danger small">{{ form.build_command.errors|join:', ' }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="run_command" class="form-label">Custom Run Command</label>
                        <input type="text" class="form-control" id="run_command" name="run_command" placeholder="Optional" value="{{ form.run_command.value|default:'' }}">
                        <div class="form-text">Optional. If empty, container will run the built image's default CMD</div>
                        {% if form.run_command.errors %}
                        <div class="text-danger small">{{ form.run_command.errors|join:', ' }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="env_vars" class="form-label">Environment Variables</label>
                        <textarea class="form-control" id="env_vars" name="env_vars" rows="5" placeholder="KEY=VALUE\nANOTHER_KEY=another_value">{{ form.env_vars.value|default:'' }}</textarea>
                        <div class="form-text">One per line in KEY=VALUE format. Lines starting with # are ignored.</div>
                        {% if form.env_vars.errors %}
                        <div class="text-danger small">{{ form.env_vars.errors|join:', ' }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'core:dashboard' %}" class="btn btn-secondary">Cancel</a>
                        {% if has_github_connected %}
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-plus"></i> Create Project
                        </button>
                        {% else %}
                        <a href="{% url 'core:github_login' %}" class="btn btn-dark">
                            <i class="bi bi-github"></i> ล็อกอิน GitHub เพื่อสร้าง
                        </a>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- GitHub connect modal -->
<div class="modal fade" id="githubConnectModal" tabindex="-1" aria-labelledby="githubConnectLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="githubConnectLabel"><i class="bi bi-github me-2"></i>เชื่อมต่อ GitHub ก่อนสร้างโปรเจ็กต์</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-3">คุณยังไม่ได้เชื่อมบัญชี GitHub กับ LaunchHub โปรดเชื่อมต่อเพื่อดึงข้อมูล repository และจัดการการ deploy ได้สะดวก</p>
        <div class="d-flex flex-column gap-2">
          <a href="{% url 'core:github_login' %}" class="btn btn-dark"><i class="bi bi-github me-1"></i>เชื่อม GitHub</a>
          <a href="{% url 'core:edit_profile' %}" class="btn btn-outline-secondary"><i class="bi bi-gear me-1"></i>ไปที่ Settings</a>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
      </div>
    </div>
  </div>
 </div>

<script>
// Auto-generate project name from GitHub URL
const repoUrlInput = document.getElementById('github_repo_url');
const nameInput = document.getElementById('name');

repoUrlInput.addEventListener('blur', function() {
    const url = this.value;
    if (url && !nameInput.value) {
        const match = url.match(/github\.com\/[^\/]+\/([^\/]+)/);
        if (match) {
            nameInput.value = match[1].replace('.git', '');
        }
    }
});

// If user selects from dropdown, fill URL and name
const repoSelect = document.getElementById('repo_select');
if (repoSelect) {
    repoSelect.addEventListener('change', function() {
        const selected = this.options[this.selectedIndex];
        const cloneUrl = selected.value;
        const repoName = selected.getAttribute('data-name');
        if (cloneUrl) {
            repoUrlInput.value = cloneUrl;
        }
        if (repoName && !nameInput.value) {
            nameInput.value = repoName;
        }
    });
}

// Show GitHub connect modal if required
document.addEventListener('DOMContentLoaded', function() {
  const requireGithub = {{ require_github|yesno:'true,false' }};
  if (requireGithub) {
    const modalEl = document.getElementById('githubConnectModal');
    if (modalEl) {
      const modal = new bootstrap.Modal(modalEl);
      modal.show();
    }
  }
});
</script>
{% endblock %}