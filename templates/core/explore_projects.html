{% extends 'core/base.html' %}

{% block title %}Explore Projects - LaunchHub{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-compass"></i> Explore Public Projects</h1>
</div>

<div class="row mb-4">
    <div class="col-md-8">
        <div class="input-group">
            <input type="text" class="form-control" id="projectSearch" name="q" placeholder="Search projects by name..." value="{{ q|default:'' }}">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
        </div>
    </div>
    <div class="col-md-4">
        <div class="input-group">
            <input type="text" class="form-control" id="tagSearch" name="tag" placeholder="Search by tag..." value="{{ selected_tag_name }}">
            <span class="input-group-text"><i class="bi bi-tag"></i></span>
        </div>
    </div>
</div>

{% if q %}
<p class="text-muted">Showing results for "{{ q }}"</p>
{% endif %}

<div id="tagFilterInfo" class="alert alert-info {% if not selected_tag %}d-none{% endif %}">
    <i class="bi bi-tag"></i> Showing projects with tag: <strong id="selectedTagName">{{ selected_tag_name }}</strong>
    <a href="#" id="clearTagFilter" class="btn btn-sm btn-outline-secondary ms-2">Clear filter</a>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const projectSearch = document.getElementById('projectSearch');
    const tagSearch = document.getElementById('tagSearch');
    const tagFilterInfo = document.getElementById('tagFilterInfo');
    const selectedTagName = document.getElementById('selectedTagName');
    const clearTagFilter = document.getElementById('clearTagFilter');
    const projectsContainer = document.querySelector('.row.g-3');
    
    let searchTimeout;
    
    // Function to perform search with debounce
    function performSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            const searchQuery = projectSearch.value;
            const tagQuery = tagSearch.value;
            
            // Build URL with query parameters
            let url = '{% url "core:explore_projects" %}?';
            if (searchQuery) {
                url += `q=${encodeURIComponent(searchQuery)}&`;
            }
            if (tagQuery) {
                url += `tag=${encodeURIComponent(tagQuery)}`;
            }
            
            // Fetch results
            fetch(url)
                .then(response => response.text())
                .then(html => {
                    // Create a temporary element to parse the HTML
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = html;
                    
                    // Extract the projects container
                    const newProjectsContainer = tempDiv.querySelector('.row.g-3');
                    if (newProjectsContainer) {
                        projectsContainer.innerHTML = newProjectsContainer.innerHTML;
                    }
                    
                    // Update tag filter info if needed
                    const newTagFilterInfo = tempDiv.querySelector('#tagFilterInfo');
                    if (newTagFilterInfo) {
                        const isVisible = !newTagFilterInfo.classList.contains('d-none');
                        tagFilterInfo.classList.toggle('d-none', !isVisible);
                        
                        if (isVisible) {
                            const newTagName = tempDiv.querySelector('#selectedTagName');
                            if (newTagName) {
                                selectedTagName.textContent = newTagName.textContent;
                            }
                        }
                    } else {
                        tagFilterInfo.classList.add('d-none');
                    }
                    
                    // Re-attach event listeners to new elements
                    attachEventListeners();
                })
                .catch(error => console.error('Error fetching search results:', error));
        }, 300); // 300ms debounce
    }
    
    // Attach event listeners to search inputs
    projectSearch.addEventListener('input', performSearch);
    tagSearch.addEventListener('input', performSearch);
    
    // Clear tag filter
    clearTagFilter.addEventListener('click', function(e) {
        e.preventDefault();
        tagSearch.value = '';
        tagFilterInfo.classList.add('d-none');
        performSearch();
    });
    
    // Function to attach event listeners to dynamic elements
    function attachEventListeners() {
        // Add any event listeners for dynamically loaded content here
    }
});
</script>

{% if projects %}
<div class="row g-3">
    {% for project in projects %}
    <div class="col-md-6 col-lg-4">
        <div class="card h-100">
            <div class="card-body d-flex flex-column">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h5 class="card-title mb-0">
                        <a href="{% url 'core:project_detail' project.id %}" class="text-decoration-none">
                            {{ project.name }}
                        </a>
                    </h5>
                    <span class="badge bg-success"><i class="bi bi-globe"></i> Public</span>
                </div>
                <p class="card-text text-muted mb-2">
                    Owner:
                    <a href="{% url 'core:public_profile' project.owner.username %}" class="text-decoration-none">
                        <i class="bi bi-person"></i> {{ project.owner.username }}
                    </a>
                </p>
                
                <!-- Project Tags -->
                <div class="mb-2">
                    {% for tag in project.tags.all %}
                        <a href="{% url 'core:explore_projects' %}?tag={{ tag.slug }}" class="badge bg-info text-decoration-none">
                            {{ tag.name }}
                        </a>
                    {% endfor %}
                </div>
                
                {% with preview=project.get_preview_url %}
                <div class="mt-auto d-flex gap-2">
                    {% if preview %}
                    <a href="{{ preview }}" target="_blank" class="btn btn-sm btn-outline-success">
                        <i class="bi bi-box-arrow-up-right"></i> Preview
                    </a>
                    {% else %}
                    <span class="text-muted small d-inline-flex align-items-center">
                        <i class="bi bi-hourglass-split me-1"></i> No live preview
                    </span>
                    {% endif %}
                    <a href="{% url 'core:public_profile' project.owner.username %}" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-person"></i> Profile
                    </a>
                </div>
                {% endwith %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="text-center py-5">
    <i class="bi bi-search display-4 text-muted"></i>
    <p class="text-muted mt-3">No public projects found.</p>
</div>
{% endif %}
{% endblock %}